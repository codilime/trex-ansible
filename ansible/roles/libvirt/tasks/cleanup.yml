---

- name: set vm name fact to trex-{{ vm+1 }}
  set_fact:
    vm_name: "trex-{{ vm+1 }}"

- name: shutdown {{ vm_name }}
  virt:
    name: "{{ vm_name }}"
    state: shutdown
  ignore_errors: true

- name: undefine {{ vm_name }}
  virt:
    name: "{{ vm_name }}"
    command: undefine
  ignore_errors: true

- name: delete {{ vm_name }} disk volume
  command:
    virsh vol-delete --pool {{ libvirt_pool_name }} {{ vm_name }}-disk.qcow
  ignore_errors: true

- name: remove {{ vm_name }} meta-data, user-data and nocloud iso
  file:
    dest: "{{ libvirt_pool_dir }}/{{ vm_name }}-{{ data_file }}"
    state: absent
  loop:
    - user-data.txt
    - meta-data.txt
    - nocloud.iso
  loop_control:
    loop_var: data_file
